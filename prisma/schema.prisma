generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OPERATOR
}

enum PaymentMethod {
  CASH
  TRANSFER
  MOBILE_PAYMENT
  DEBIT
  CREDIT
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          Role      @default(OPERATOR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sales         Sale[]
  purchases     InventoryPurchase[]
  expenses      Expense[]
  transfers     Transfer[]
  statements    BankStatement[]
  investments   PartnerInvestment[]
  withdrawals   PartnerWithdrawal[]
  logs          ActivityLog[]
}

model Product {
  id          String    @id @default(cuid())
  name        String
  category    String    // 'HAMBURGUESA', 'PERRO', 'PAPAS', 'BEBIDA', 'OTRO'
  price       Decimal   @db.Decimal(10, 2)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  saleItems   SaleItem[]
}

model Sale {
  id            String        @id @default(cuid())
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  date          DateTime      @default(now())
  notes         String?
  imageUrl      String?       // Comprobante si es transferencia
  paymentReference String?    // Last 4 digits for Transfer/Mobile Payment
  
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  items         SaleItem[]
  
  createdAt     DateTime      @default(now())
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id])
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)
  productName String? // Snapshot of product name or custom description
}

model InventoryCategory {
  id    String          @id @default(cuid())
  name  String          @unique // SALSAS, PROTEÍNAS, OTROS, DESECHABLES
  items InventoryItem[]
}

model InventoryItem {
  id          String            @id @default(cuid())
  
  categoryId  String
  category    InventoryCategory @relation(fields: [categoryId], references: [id])
  
  name        String
  unit        String            // kg, unidades, litros, paquetes
  currentStock Decimal          @default(0) @db.Decimal(10, 2)
  minStock    Decimal           @default(0) @db.Decimal(10, 2)
  active      Boolean           @default(true)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  purchases   InventoryPurchase[]
}

model InventoryPurchase {
  id          String        @id @default(cuid())
  
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id])
  
  quantity    Decimal       @db.Decimal(10, 2)
  price       Decimal       @db.Decimal(10, 2)
  supplier    String?
  receiptUrl  String?       // Foto de factura
  
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  date        DateTime      @default(now())
  createdAt   DateTime      @default(now())
}

model Expense {
  id          String    @id @default(cuid())
  category    String    // Transporte, Servicios, Alquiler, Mantenimiento, Otros
  description String
  amount      Decimal   @db.Decimal(10, 2)
  receiptUrl  String?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  date        DateTime  @default(now())
  createdAt   DateTime  @default(now())
}

model Transfer {
  id          String    @id @default(cuid())
  amount      Decimal   @db.Decimal(10, 2)
  sender      String
  bankMethod  String
  type        String    // Inversión, Préstamo, Venta externa
  receiptUrl  String?
  verified    Boolean   @default(false)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  date        DateTime  @default(now())
  createdAt   DateTime  @default(now())
}

model BankStatement {
  id          String    @id @default(cuid())
  month       Int
  year        Int
  bank        String
  fileUrl     String    // PDF o imagen
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  uploadedAt  DateTime  @default(now())
}

model PartnerInvestment {
  id          String    @id @default(cuid())
  partnerName String
  amount      Decimal   @db.Decimal(10, 2)
  type        String    // capital inicial, reposición, emergencia
  description String?
  proofUrl    String?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id]) // Quien registra

  date        DateTime  @default(now())
  createdAt   DateTime  @default(now())
}

model PartnerWithdrawal {
  id          String    @id @default(cuid())
  partnerName String
  amount      Decimal   @db.Decimal(10, 2)
  concept     String    // utilidades, préstamo personal
  
  userId      String
  user        User      @relation(fields: [userId], references: [id]) // Quien registra
  
  date        DateTime  @default(now())
  createdAt   DateTime  @default(now())
}

model ActivityLog {
  id          String    @id @default(cuid())
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  action      String    // CREATED, UPDATED, DELETED
  tableName   String
  recordId    String
  details     String?   // JSON string con detalles del cambio
  
  timestamp   DateTime  @default(now())
}
